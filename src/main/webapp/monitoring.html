<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>TODO supply a title</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <script src="/camunda/varna/static/js/chart_js/Chart.bundle.min.js"></script>
        <script
            src="https://code.jquery.com/jquery-3.1.1.min.js"
        crossorigin="anonymous"></script>
    </head>
    <body>
        <form>
            Stav: <div id="stage"></div>
            <div id="stageStartOuter">Začátek prodlevy: <div id="stageStart"></div></div>
            <div id="countdownOuter">Prodleva: <div id="countdown"></div></div>
            Teplota: <div id="temp"></div>
            Výkon: <div id="power"></div>
            <div style="width:100%;">
                <canvas id="myChart"></canvas>

            </div>
            <script cam-script type="text/form-script">

                debugger;
                var moment = require('moment');
                inject(['$http', 'Uri', function ($http, Uri) {
                        camForm.on('form-loaded', function () {
                            $http.get(Uri.appUri('engine://engine/:engine/task/' + camForm.taskId)).success(
                                    function (result) {
                                        $scope.processInstanceId = result.processInstanceId;
                                        var updateFrom = function () {
                                            $.getJSON("/camunda/varna/api/diagram/data?procInstId=" + $scope.processInstanceId, function (data) {
                                                var tempMeasured;
                                                var tempSet;
                                                var power;
                                                var time;
                                                for (var property in data) {
                                                    if (data.hasOwnProperty(property)) {
                                                        if (property === "Naměřená teplota")
                                                            tempMeasured = data[property];
                                                        else if (property === "Nastavená teplota")
                                                            tempSet = data[property];
                                                        else if (property === "Výkon")
                                                            power = data[property];
                                                        else if (property === "Čas")
                                                            time = data[property];
                                                    }
                                                }

                                                data = {
                                                    labels: time,
                                                    datasets: [
                                                        {
                                                            type: 'line',
                                                            label: "Naměřená teplota",
                                                            borderColor: 'rgba(0, 255, 0, 1)',
                                                            backgroundColor: 'rgba(0, 0, 0, 0)',
                                                            data: tempMeasured
                                                        },
                                                        //                        {
                                                        //                            type: 'line',
                                                        //                            label: "Nastavená teplota",
                                                        //                            borderColor: 'rgba(0, 0, 255, 1)',
                                                        //                            backgroundColor: 'rgba(0, 0, 0, 0)',
                                                        //                            data: tempSet
                                                        //                        },
                                                        {
                                                            type: "line",
                                                            label: "Výkon",
                                                            borderColor: 'rgba(255, 0, 0, 1)',
                                                            backgroundColor: 'rgba(255, 0, 0, 0.3)',
                                                            data: power,
                                                        }
                                                    ]
                                                };
                                                var ctx = document.getElementById("myChart");
                                                var myLineChart = new Chart(ctx, {
                                                    type: "bar",
                                                    data: data,
                                                    options: {
                                                        scales: {
                                                            xAxes: [{
                                                                    type: 'time',
                                                                    time: {
                                                                        unit: 'hour',
                                                                        tooltipFormat: 'HH:mm',
                                                                        displayFormats: {
                                                                            hour: 'HH:mm'
                                                                        }
                                                                    }
                                                                }]
                                                        },
                                                        animation: false,
                                                        elements: { point: { radius: 0 } } 
                                                    }
                                                });

                                            });
                                        }
                                        
                                        
                                        
                                       


                                        updateFrom();
                                         //nastavení odpočítávání
//
                                        var updateCurrent = function () {
                                            $.getJSON("/camunda/varna/api/diagram/current?procInstId=" + $scope.processInstanceId, function (data) {
                                            
                                                var eventTime = moment(data.stageStart).add(data.time, "minutes").format("X");
                                                var currentTime = moment().format("X");
                                                var diffTime = eventTime - currentTime;
                                                var duration = moment.duration(diffTime*1000, 'milliseconds');
                                                var interval = 1000;
                                                $("#power").html(data.power1);
                                                $("#temp").html(data.temp1);
                                                $("#stage").html(data.stage);
                                                if(data.stageStart !== "null"){
                                                    $("#stageStartOuter").show();
                                                    $("#countdownOuter").show();
                                                    $("#stageStart").html(moment(data.stageStart).format("HH:mm"));
                                                    var sign = ((diffTime < 0)?"-":"");
                                                    $("#countdown").html(sign + duration.hours() + ":" + formatDurationTime(duration.minutes().toString()) + ":" + formatDurationTime(duration.seconds().toString()));
                                                }else{
                                                    $("#stageStartOuter").hide();
                                                    $("#countdownOuter").hide();
                                                }
                                            })
                                        };
                                        var formatDurationTime = function(string){
                                            string = string.replace("-","");
                                            if(string.length == 1){
                                                return "0"+string;
                                            }
                                            return string;
                                        }
                                        updateCurrent();
                                        var refreshDiagram = setInterval(function () {
                                            updateFrom()
                                        }, 10000);
                                        var refreshCurrent = setInterval(function () {
                                            updateCurrent()
                                        }, 1000);
                                    }
                            );

                        });
                    }]);
                
                
                        




            </script>
        </form>

    </body>
</html>
